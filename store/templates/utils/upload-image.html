{% block image_upload %}

<div class="items-center justify-center min-w-64 max-w-lg">
    <input type="file" multiple>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet" />

<link
    href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
    rel="stylesheet"
/>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
<script src="https://unpkg.com/filepond/dist/filepond.js"></script>

<script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        var files = []
        FilePond.registerPlugin(FilePondPluginFileValidateSize);
        FilePond.registerPlugin(FilePondPluginFileValidateType);
        FilePond.registerPlugin(FilePondPluginImagePreview);
        FilePond.setOptions({
            allowMultiple:true,
            labelMaxFileSizeExceeded: "Le fichier est trop volumineux",
            maxFiles:3,
            maxFileSize: '5MB'
        })
        const inputElement = document.querySelector('input[type="file"]');
        const pond = FilePond.create( inputElement, {
            acceptedFileTypes:['image/png', 'image/jpeg'],
            onaddfile: (err, fileItem) => {
                if (!err) {
                files.push(fileItem.file)
                }
                console.log(files)
            },
            onremovefile: (err, fileItem) => {
                const index = files.indexOf(fileItem.file)
                if (index > -1) {
                    files.splice(index, 1)
                }
                console.log(files)
            }
        } );

        document.getElementById('mainForm').addEventListener('submit', function(e) {
            e.preventDefault();

            e.preventDefault();

            // Add data to the form
            var length = document.createElement('input');
            length.type = 'hidden';
            length.name = 'length'; // Name of the new data
            length.value = files.length; // Value of the new data
            // Append the input to the form
            this.appendChild(length);

            // Add data to the form
            var formData = new FormData(this);
            for (var i = 0; i < files.length; i++) {
                formData.append('images' + i, files[i]);
            }
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')

            // Submit the form data using fetch (or another method)
            {% if arg1 and arg2 %}
            fetch('{% url dest arg1 arg2 %}', {
            {% elif arg1 %}
            fetch('{% url dest arg1 %}', {
            {% else %}
            fetch('{% url dest %}', {
            {% endif %}
                method: 'POST',
                body: formData
            }).then(response => {
                if (!response.ok) {
                    console.log('Response status:', response.status);
                    console.log('Response status text:', response.statusText);
                    throw new Error('Erreur lors de l\'envoi des donnÃ©es au serveur');
                }
                return response.json();
            }).then(data => {
                // Redirect to the URL returned from the server
                window.location.href = data.redirect_url;
            }).catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        });
    });
</script>

{% endblock image_upload %}